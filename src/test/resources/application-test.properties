# Base de datos con TestContainers
# TC_DAEMON=true permite que el contenedor persista entre tests
# TC_TMPFS=/testtmpfs:rw mejora el rendimiento de I/O
spring.datasource.url=jdbc:tc:postgresql:15.7:///test?currentSchema=umc_sp&TC_DAEMON=true&TC_TMPFS=/testtmpfs:rw
spring.datasource.username=test
spring.datasource.password=test
spring.datasource.driver-class-name=org.testcontainers.jdbc.ContainerDatabaseDriver

# Configuración del pool de conexiones para establecer search_path
spring.datasource.hikari.connectionInitSql=SET search_path TO umc_sp
# Aumentar timeouts para operaciones largas como CREATE INDEX CONCURRENTLY
spring.datasource.hikari.connectionTimeout=300000
spring.datasource.hikari.validationTimeout=300000
spring.datasource.hikari.maxLifetime=1800000
spring.datasource.hikari.keepaliveTime=300000

# Schema y configuración de JPA/Flyway para pruebas
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.default_schema=umc_sp

spring.flyway.enabled=true
# Usar migraciones especiales para tests sin CONCURRENTLY
spring.flyway.locations=classpath:db/migration-test
spring.flyway.default-schema=umc_sp
spring.flyway.schemas=umc_sp
spring.flyway.create-schemas=true
spring.flyway.mixed=true
spring.flyway.clean-disabled=false
spring.flyway.validate-on-migrate=true
# Establecer search_path para las migraciones de Flyway
spring.flyway.init-sqls=SET search_path TO umc_sp
# Aumentar timeout para migraciones con índices concurrentes
spring.flyway.connect-retries=10
spring.flyway.connect-retries-interval=60
# Evitar inicialización SQL automática de Spring
spring.sql.init.mode=never

# Configuraciones comentadas para uso futuro
# spring.data.redis.host=${redis.host}
# spring.data.redis.port=${redis.port}
# spring.elasticsearch.rest.uris=http://${elasticsearch.host}:${elasticsearch.port}

# Exclusiones de autoconfiguración para servicios no utilizados en tests
spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRepositoriesAutoConfiguration,org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRestClientAutoConfiguration,org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRestClientAutoConfiguration,org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration

# Deshabilitar health checks de servicios externos
management.health.elasticsearch.enabled=false


content.resource.videos.url = https://test/content/videos/%s/
content.assets.videos.url = https://test/assets/videos/%s/images/
content.assets.series.url = https://test/assets/series/%s/images/
content.assets.experts.url = https://test/assets/experts/%s/images/

#spring.jpa.show-sql=true
#spring.jpa.properties.hibernate.format_sql=true
#logging.level.org.hibernate.SQL=DEBUG
#logging.level.org.hibernate.type.descriptor.sql=TRACE

logging.level.reactor.netty.http.client=DEBUG


logging.level.org.springframework.web.reactive.function.client.ExchangeFunctions: DEBUG
logging.level.org.springframework.web.reactive.function.client.ExchangeFilterFunction: DEBUG
